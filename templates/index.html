<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Analyse temps r√©el des flux</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; color: #333; margin: 0; padding: 20px; }
    h2 { font-size: 25px; text-align: center; color: #444; }
    form { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
    fieldset { border: none; margin-bottom: 10px; }
    legend { font-weight: bold; margin-bottom: 6px; }
    label { margin-right: 15px; }
    button { background: #007bff; color: white; padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; }
    button:hover { background: #0056b3; }
    #dashboard { display: flex; gap: 20px; margin-top: 20px; align-items: flex-start; }
    #right-container { display: flex; flex-direction: column; gap: 20px; width: 500px; }
    #kpi-row { display: flex; gap: 20px; margin-bottom: 10px; }
    .kpi-card { flex: 1; text-align: center; padding: 15px; border-radius: 10px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .kpi-card h3 { font-size: 20px; color: #666; margin-bottom: 10px; }
    .kpi-card span { display: block; font-size: 40px; font-weight: bold; color: #007bff; }
    img { border-radius: 8px; max-width: 100%; }
    canvas { background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .roi { margin-bottom: 10px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>Analyse temps r√©el des flux</h2>

  <form id="source-form">
    <fieldset>
      <legend>Source</legend>
      <label><input type="radio" name="source" value="webcam" checked> Webcam</label>
      <label><input type="radio" name="source" value="video"> Vid√©o</label>
      <input type="file" id="video-file" name="video" style="display:none;">
    </fieldset>

    <fieldset>
      <legend>T√¢che</legend>
      <label><input type="radio" name="task" value="detect" checked> Detection</label>
      <label><input type="radio" name="task" value="pose"> Pose</label>
    </fieldset>

    <fieldset>
      <legend>Taille du mod√®le</legend>
      <label><input type="radio" name="size" value="n" checked> N</label>
      <label><input type="radio" name="size" value="s"> S</label>
      <label><input type="radio" name="size" value="m"> M</label>
      <label><input type="radio" name="size" value="l"> L</label>
      <label><input type="radio" name="size" value="x"> X</label>
      <label><input type="radio" name="size" value="custom"> Notre mod√®le</label>
    </fieldset>

    <fieldset>
      <legend>Zones d'int√©r√™t (ROIs)</legend>
      <div id="rois-container">
        <div class="roi">
          Point 1: X <input type="number" name="x1" value="0" style="width:50px;"> Y <input type="number" name="y1" value="0" style="width:50px;">
          Point 2: X <input type="number" name="x2" value="0" style="width:50px;"> Y <input type="number" name="y2" value="0" style="width:50px;">
          Point 3: X <input type="number" name="x3" value="0" style="width:50px;"> Y <input type="number" name="y3" value="0" style="width:50px;">
          Point 4: X <input type="number" name="x4" value="0" style="width:50px;"> Y <input type="number" name="y4" value="0" style="width:50px;">
        </div>
      </div>
      <button type="button" id="add-roi">Ajouter une zone</button>
    </fieldset>

    <button type="submit">‚ñ∂ Lancer</button>
  </form>

  <div style="margin: 20px 0;">
    <h3>üì• Export</h3>
    <div style="display: flex; gap: 10px;">
      <button onclick="window.location.href='/export'">Comptages</button>
      <button onclick="window.location.href='/export_frames'">D√©taill√©</button>
    </div>
  </div>

  <div id="dashboard">
    <div id="video-container" class="card">
      <img id="video-stream" width="640" height="480" style="width:640px; height:480px;">
    </div>
    <div id="right-container">
      <div id="kpi-row">
        <div class="kpi-card">
          <h3>Comptages</h3>
          <span id="kpi">0</span>
        </div>
        <div class="kpi-card">
          <h3>FPS</h3>
          <span id="fps">0</span>
        </div>
      </div>
      <div id="chart-container" class="card">
        <canvas id="kpiChart" width="600" height="400"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const form = document.getElementById("source-form");
    const videoFileInput = document.getElementById("video-file");
    const videoStream = document.getElementById("video-stream");
    const kpiSpan = document.getElementById("kpi");
    const fpsSpan = document.getElementById("fps");
    const roisContainer = document.getElementById("rois-container");
    const addRoiBtn = document.getElementById("add-roi");

    let ws;

    // Afficher/cacher input vid√©o selon source
    form.addEventListener("change", (e) => {
      if (e.target.value === "video") videoFileInput.style.display = "block";
      else if (e.target.value === "webcam") videoFileInput.style.display = "none";
    });

    // Ajouter un nouveau ROI
    addRoiBtn.addEventListener("click", () => {
      const div = document.createElement("div");
      div.className = "roi";
      div.innerHTML = `
        Point 1: X <input type="number" name="x1" value="0" style="width:50px;"> Y <input type="number" name="y1" value="0" style="width:50px;">
        Point 2: X <input type="number" name="x2" value="640" style="width:50px;"> Y <input type="number" name="y2" value="0" style="width:50px;">
        Point 3: X <input type="number" name="x3" value="640" style="width:50px;"> Y <input type="number" name="y3" value="480" style="width:50px;">
        Point 4: X <input type="number" name="x4" value="0" style="width:50px;"> Y <input type="number" name="y4" value="480" style="width:50px;">
      `;
      roisContainer.appendChild(div);
    });

    // Submit form
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const source = document.querySelector('input[name="source"]:checked').value;
      const task = document.querySelector('input[name="task"]:checked').value;
      const size = document.querySelector('input[name="size"]:checked').value;

      // R√©cup ROIs
      const rois = Array.from(document.querySelectorAll('.roi')).map(div => {
        return [
          [parseInt(div.querySelector('input[name="x1"]').value), parseInt(div.querySelector('input[name="y1"]').value)],
          [parseInt(div.querySelector('input[name="x2"]').value), parseInt(div.querySelector('input[name="y2"]').value)],
          [parseInt(div.querySelector('input[name="x3"]').value), parseInt(div.querySelector('input[name="y3"]').value)],
          [parseInt(div.querySelector('input[name="x4"]').value), parseInt(div.querySelector('input[name="y4"]').value)]
        ];
      });

      let videoPath = null;
      if (source === "video") {
        const file = videoFileInput.files[0];
        const formData = new FormData();
        formData.append("file", file);
        const response = await fetch("/upload_video", { method: "POST", body: formData });
        const data = await response.json();
        videoPath = data.path;
      }

      // Construire URL stream
      let url = `/stream?source=${source}&task=${task}&size=${size}`;
      if (videoPath) url += `&path=${videoPath}`;
      url += `&rois=${encodeURIComponent(JSON.stringify(rois))}`;

      videoStream.src = url;

      // WebSocket KPIs
      if (ws) ws.close();
      ws = new WebSocket("ws://localhost:8000/ws/detections");
      ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const now = new Date().toLocaleTimeString();
        kpiSpan.innerText = data.detections;
        fpsSpan.innerText = data.fps.toFixed(2);

        kpiChart.data.labels.push(now);
        kpiChart.data.datasets[0].data.push(data.detections);
        if (kpiChart.data.labels.length > 100) {
          kpiChart.data.labels.shift();
          kpiChart.data.datasets[0].data.shift();
        }
        kpiChart.update();
      };
    });

    // Chart.js
    const ctx = document.getElementById('kpiChart').getContext('2d');
    const kpiChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Comptages', data: [], fill: true, backgroundColor: 'rgba(0,123,255,0.2)', borderColor: 'rgba(0,123,255,1)', tension: 0.3 }] },
      options: { responsive: true, animation: false, scales: { x: { title: { display: true, text: 'Temps' } }, y: { beginAtZero: true, title: { display: true, text: 'Comptages' } } } }
    });
  </script>
</body>